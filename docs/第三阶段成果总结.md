# 第三阶段成果总结（截至 2025-12-17）

> **阶段目标：** 构建 **ChiseLLM 智能工作台**（Web 应用），实现 AI 驱动的 Chisel 代码生成、自动验证、Testbench 生成与波形仿真的完整闭环，并部署到 Streamlit Cloud 供外部用户使用。

---

## Ⅰ. 核心成果：ChiseLLM 智能工作台 ✅ 已完成

### 1.1 项目概述

**ChiseLLM 智能工作台** 是一个基于 Streamlit 的 Web 应用，整合了 LLM 代码生成、反射验证、Testbench 自动生成和波形仿真功能，实现了从需求描述到硬件设计验证的端到端自动化。

**在线访问**：[Streamlit Cloud 部署地址]

### 1.2 核心功能

| 功能模块 | 描述 | 状态 |
|----------|------|------|
| 🔄 **LLM 代码生成** | 支持多种 API Provider，根据自然语言需求生成 Chisel 代码 | ✅ |
| 🔍 **自动反射验证** | 编译→阐述三阶段验证，失败自动反馈给 LLM 修复 | ✅ |
| 🧪 **Testbench 自动生成** | 验证通过后自动生成 C++ Verilator Testbench | ✅ |
| 🌊 **波形仿真可视化** | VCD 转 WaveDrom 渲染，浏览器内查看波形 | ✅ |
| 📦 **一键下载** | 支持 Scala、Verilog、Testbench、VCD 及 ZIP 打包下载 | ✅ |
| 🚀 **测试配置** | 服务器预设 API，外部用户无需配置即可体验 | ✅ |

---

## Ⅱ. 技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    ChiseLLM 智能工作台 (app.py)                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐         │
│  │  侧边栏配置   │   │   对话区域   │   │  代码工作区   │         │
│  │  - API 选择  │   │  - 需求输入  │   │  - 6个Tab页  │         │
│  │  - 测试配置  │   │  - 状态反馈  │   │  - 下载中心  │         │
│  └──────────────┘   └──────────────┘   └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ChiselAgent (agent.py)                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    run_loop() 核心循环                    │    │
│  │  1. LLM 生成 Chisel → 2. 反射验证 → 3. 错误修复循环      │    │
│  │  4. Testbench 生成 → 5. 仿真验证 → 6. TB 修复循环        │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│  LLM Provider    │ │   reflect_env    │ │   vcd_parser     │
│  (llm_provider)  │ │  (reflect_env)   │ │  (vcd_parser)    │
│  - Gemini        │ │  - Mill 编译     │ │  - VCD 解析      │
│  - OpenAI        │ │  - Verilator     │ │  - WaveDrom JSON │
│  - DeepSeek      │ │  - 仿真执行      │ │  - HTML 渲染     │
│  - Claude        │ └──────────────────┘ └──────────────────┘
│  - SiliconFlow   │
│  - Custom        │
└──────────────────┘
```

### 2.2 核心模块说明

#### 2.2.1 多 LLM Provider 统一接口 (`src/llm_provider.py`)

**支持的 API Provider：**

| Provider | SDK/协议 | 默认模型 |
|----------|----------|----------|
| Google Gemini | google-generativeai | gemini-2.0-flash-exp |
| OpenAI | OpenAI SDK | gpt-4o-mini |
| Qwen (通义千问) | OpenAI 兼容 | qwen-plus |
| DeepSeek | OpenAI 兼容 | deepseek-chat |
| Anthropic Claude | anthropic SDK | claude-3-5-sonnet |
| SiliconFlow | OpenAI 兼容 | deepseek-ai/DeepSeek-V3 |
| Custom | OpenAI 兼容 | 用户自定义 |

**关键系统提示词：**

```python
CHISEL_SYSTEM_PROMPT = """你是一位 Chisel 硬件设计专家...
【严重警告：版本与语法约束】
1. 必须使用 Chisel 6.0.0 和 Scala 2.13.12 语法
2. 必须导入: import chisel3._ 和 import chisel3.util._
...
"""

TESTBENCH_SYSTEM_PROMPT = """你是一位硬件验证专家...
⚠️ 禁止事项:
- 禁止定义 struct、class、typedef
- 禁止使用 stdendl，必须用 std::endl
...
"""
```

#### 2.2.2 智能代理核心 (`src/agent.py`)

**ChiselAgent 类核心方法：**

| 方法 | 功能 |
|------|------|
| `from_config()` | 工厂方法，从配置创建 Agent |
| `extract_code()` | 从 LLM 响应提取 Scala 代码 |
| `extract_cpp_code()` | 从 LLM 响应提取 C++ 代码 |
| `_fix_cpp_common_errors()` | 后处理修复常见错误 |
| `generate_testbench()` | 生成 C++ Verilator Testbench |
| `run_loop()` | **核心循环**：生成→验证→修复→仿真 |

**run_loop() 工作流程：**

```
┌──────────────────────────────────────────────────────────────────┐
│                        run_loop() 流程                           │
├──────────────────────────────────────────────────────────────────┤
│  阶段1: Chisel 代码生成与验证 (max_retries=3)                     │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐       │
│  │ LLM生成 │ → │ 反射验证 │ → │ 失败?   │ → │ LLM修复 │ ──┐    │
│  └─────────┘    └─────────┘    └────┬────┘    └─────────┘   │    │
│                                     │ 成功                  │    │
│                                     ▼                       │    │
│  阶段2: Testbench 生成与仿真 (max_tb_retries=3)        ◄────┘    │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐       │
│  │ TB生成  │ → │ 仿真验证 │ → │ 失败?   │ → │ TB修复  │ ──┐    │
│  └─────────┘    └─────────┘    └────┬────┘    └─────────┘   │    │
│                                     │ 成功                  │    │
│                                     ▼                  ◄────┘    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 返回结果: code, verilog, testbench, vcd_content         │    │
│  └─────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
```

#### 2.2.3 VCD 波形解析器 (`src/vcd_parser.py`)

**核心功能：**

| 函数 | 功能 |
|------|------|
| `vcd_to_wavedrom()` | 将 VCD 文件转换为 WaveDrom JSON |
| `generate_wavedrom_html()` | 生成可嵌入的 HTML 波形渲染页面 |

**关键特性：**
- 自动按短名称去重，避免层级路径导致的信号重复
- 支持单位信号和多位总线的不同渲染方式
- 使用 `.` 表示信号延续，避免 WaveDrom 渲染尖峰
- 限制最多显示 10 个信号，最多 30 个时钟周期

---

## Ⅲ. Web 界面设计

### 3.1 页面布局

```
┌────────────────────────────────────────────────────────────────────────┐
│ ⚡ ChiseLLM 智能工作台                                                  │
│ AI 驱动的 Chisel 硬件设计生成与验证平台                                  │
├────────────┬───────────────────────────────────────────────────────────┤
│  🔧 API配置 │              💬 需求对话          │    💻 代码工作区       │
│            │                                  │                       │
│ ☑️ 使用测试 │  User: 写一个8位寄存器           │ [Chisel][Verilog]     │
│    配置    │                                  │ [Testbench][波形]     │
│            │  Assistant: 好的，我来为您...     │ [报告][下载]          │
│ 📡 测试模式 │                                  │                       │
│    已启用  │  🔄 正在验证...                   │ ```scala              │
│            │  ✅ 编译阐述成功！                │ class Reg8 extends... │
│ - API: SF  │  🧪 生成Testbench...             │ ```                   │
│ - 模型: V3 │  ✅ 仿真测试通过！                │                       │
│ - 状态: ✅ │                                  │                       │
└────────────┴───────────────────────────────────────────────────────────┘
```

### 3.2 代码工作区 Tab 页

| Tab | 内容 |
|-----|------|
| 📐 Chisel 源码 | 语法高亮显示生成的 Scala 代码 |
| 📝 Verilog | Elaboration 生成的 Verilog 代码 |
| 🧪 Testbench | C++ Verilator Testbench |
| 🌊 波形仿真 | WaveDrom 渲染的波形图 |
| 📊 验证报告 | Elaboration/Simulation 状态及详细 JSON |
| 📦 下载中心 | 单文件下载 + ZIP 项目包 |

---

## Ⅳ. Streamlit Cloud 部署

### 4.1 部署配置

**目录结构：**
```
ChiseLLM/
├── app.py                    # Streamlit 入口
├── requirements.txt          # Python 依赖
├── .streamlit/
│   └── secrets.toml          # API 密钥 (本地，不上传)
└── src/
    ├── agent.py
    ├── llm_provider.py
    ├── reflect_env.py
    └── vcd_parser.py
```

### 4.2 Secrets 配置

在 Streamlit Cloud 控制台配置：

```toml
[default]
api_key = "sk-xxxxx"
base_url = "https://api.siliconflow.cn/v1"
model_name = "deepseek-ai/DeepSeek-V3"
```

### 4.3 测试配置功能

**设计目标：** 让外部用户无需配置 API Key 即可体验系统功能。

**实现方式：**
- 服务器端通过 `st.secrets` 存储预设 API 配置
- 前端显示友好的配置摘要，不暴露敏感信息
- 勾选"使用测试配置"即可直接使用

```python
# 安全地检查是否有服务器预设的测试 API
def check_has_default():
    try:
        return hasattr(st, 'secrets') and 'default' in st.secrets \
               and st.secrets["default"].get("api_key")
    except:
        return False
```

---

## Ⅴ. 关键问题与解决方案

### 5.1 LLM 生成代码常见错误

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `stdendl` 语法错误 | LLM 错误拼写 | `_fix_cpp_common_errors()` 正则替换 |
| 时钟不翻转 | 循环次数过少 | 自动检测并修正循环次数至 50 |
| 使用 struct/class | LLM 未遵循模板 | 加强 Prompt 约束 + 重试修复 |
| VCD 文件名错误 | LLM 自定义文件名 | Prompt 强调 + 代码后处理 |

### 5.2 VCD 波形渲染问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 信号重复显示 | VCD 层级路径不同 | 按短名称去重 |
| 波形尖峰 | WaveDrom 重复值渲染 | 使用 `.` 表示值延续 |
| vcd.signals 类型错误 | vcdvcd 返回 list 而非 dict | 添加类型检查 |
| tv_time 类型错误 | 字符串而非整数 | 添加 int() 转换 |

### 5.3 云端部署问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| secrets 不可用 | .gitignore 排除了 secrets.toml | 在 Streamlit Cloud 控制台手动配置 |
| 测试配置复选框禁用 | `has_default` 检测失败 | 改为始终可用，勾选后检测 |
| 依赖安装失败 | 缺少系统依赖 | 确认 requirements.txt 完整 |

---

## Ⅵ. 代码统计

### 6.1 新增/修改文件

| 文件 | 行数 | 说明 |
|------|------|------|
| `app.py` | ~476 | Streamlit Web 应用主入口 |
| `src/agent.py` | ~383 | 智能代理核心逻辑 |
| `src/llm_provider.py` | ~350 | 多 LLM Provider 统一接口 |
| `src/vcd_parser.py` | ~250 | VCD 解析与波形渲染 |

### 6.2 核心 API 调用链

```
app.py
  └── ChiselAgent.from_config()
        └── create_provider()
              └── GeminiProvider / OpenAICompatibleProvider / ClaudeProvider
  └── agent.run_loop()
        ├── provider.send_message()  # LLM 调用
        ├── reflect()                # 反射验证
        ├── generate_testbench()     # TB 生成
        └── reflect() with testbench # 仿真验证
  └── vcd_to_wavedrom()              # 波形转换
  └── generate_wavedrom_html()       # 波形渲染
```

---

## Ⅶ. 使用示例

### 7.1 本地运行

```bash
# 激活环境
conda activate chisel-llm

# 配置 API (首次)
mkdir -p .streamlit
cat > .streamlit/secrets.toml << 'EOF'
[default]
api_key = "your-api-key"
base_url = "https://api.siliconflow.cn/v1"
model_name = "deepseek-ai/DeepSeek-V3"
EOF

# 启动应用
streamlit run app.py --server.port 8501
```

### 7.2 示例对话

**用户输入：**
> 写一个带同步复位的 8 位寄存器，输入 d，输出 q，使能信号 en

**系统输出：**
1. 生成 Chisel 代码
2. 自动编译阐述验证
3. 生成 Verilog
4. 自动生成 C++ Testbench
5. 运行 Verilator 仿真
6. 渲染波形图
7. 提供下载链接

---

## Ⅷ. 后续规划

### 8.1 功能增强
- [ ] 支持多模块项目
- [ ] 添加代码优化建议
- [ ] 集成更多 LLM Provider
- [ ] 支持自定义 Testbench 模板

### 8.2 用户体验
- [ ] 添加历史记录功能
- [ ] 支持代码编辑与重新验证
- [ ] 波形交互缩放
- [ ] 移动端适配

### 8.3 部署优化
- [ ] 添加使用配额限制
- [ ] 优化冷启动时间
- [ ] 添加使用统计

---

## Ⅸ. 总结

第三阶段成功构建了 **ChiseLLM 智能工作台**，实现了：

✅ **多 LLM Provider 支持**：统一接口支持 7 种 API 类型  
✅ **完整自动化闭环**：需求 → 代码 → 验证 → Testbench → 仿真 → 波形  
✅ **自愈式代码生成**：编译/仿真错误自动反馈修复  
✅ **Web 可视化界面**：Streamlit 驱动的现代化 UI  
✅ **云端部署**：Streamlit Cloud 部署，支持外部用户访问  
✅ **测试配置**：预设 API 让用户零配置体验  

该工作台为 Chisel 硬件设计的 AI 辅助开发提供了完整的工具链支持，显著降低了硬件设计的入门门槛。
